<link rel="stylesheet" href="/css/style.css">
<style>
:root {
  --primary-green: #2d5a27;
  --light-green: #7fb069;
  --pale-green: #e8f5e8;
}

/* Checkout Page Layout */
.checkout-page {
  min-height: 100vh;
  background: linear-gradient(135deg, #e8f5e8 0%, #f8f9fa 50%, #e8f5e8 100%);
  padding: 2rem 0;
}

.container {
  max-width: 1200px;
  margin: auto;
  padding: 2rem;
}

/* Checkout Header */
.checkout-header {
  background: linear-gradient(135deg, #2d5a27 0%, #3d7a33 50%, #4a7c3e 100%);
  padding: 3rem 2rem;
  border-radius: 25px;
  margin-bottom: 3rem;
  box-shadow: 0 20px 60px rgba(45, 90, 39, 0.25);
  animation: gradientShift 15s ease infinite;
  background-size: 200% 200%;
}

@keyframes gradientShift {
    0%, 100% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
}

.checkout-header h1 {
  text-align: center;
  color: white;
  margin-bottom: 2.5rem;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 1rem;
  font-size: 3rem;
  font-weight: 800;
  text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
}

/* Progress Steps */
.checkout-steps {
  display: flex;
  justify-content: space-between;
  max-width: 700px;
  margin: 0 auto;
  position: relative;
}

.checkout-steps::before {
  content: '';
  position: absolute;
  top: 25px;
  left: 60px;
  right: 60px;
  height: 4px;
  background: rgba(255,255,255,0.3);
  z-index: 0;
}

.step {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 0.75rem;
  position: relative;
  z-index: 1;
}

.step-number {
  width: 50px;
  height: 50px;
  border-radius: 50%;
  background: rgba(255,255,255,0.3);
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 700;
  font-size: 1.3rem;
  transition: all 0.4s ease;
  border: 3px solid transparent;
}

.step.active .step-number {
  background: white;
  color: var(--primary-green);
  transform: scale(1.2);
  box-shadow: 0 10px 30px rgba(255,255,255,0.4);
  border-color: #7fb069;
  animation: pulse 2s infinite;
}

@keyframes pulse {
    0%, 100% { box-shadow: 0 0 0 0 rgba(255, 255, 255, 0.7); }
    50% { box-shadow: 0 0 0 15px rgba(255, 255, 255, 0); }
}

.step-title {
  font-size: 1rem;
  color: rgba(255,255,255,0.8);
  font-weight: 500;
}

.step.active .step-title {
  color: white;
  font-weight: 700;
  text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
}

/* Content Layout */
.checkout-content {
  display: grid;
  grid-template-columns: 2fr 1fr;
  gap: 2rem;
  align-items: flex-start;
}

/* Main Content */
.checkout-main {
  background: white;
  padding: 3rem;
  border-radius: 25px;
  box-shadow: 0 20px 60px rgba(45, 90, 39, 0.15);
  transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.checkout-main:hover {
  transform: translateY(-5px);
  box-shadow: 0 30px 80px rgba(45, 90, 39, 0.25);
}

.checkout-step {
  display: none;
}

.checkout-step#step-1 {
  display: block;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}

.checkout-step h2 {
  color: var(--primary-green);
  margin-bottom: 2rem;
  display: flex;
  align-items: center;
  gap: 1rem;
  font-size: 2.5rem;
  font-weight: 700;
}

/* Buttons */
.btn {
  padding: 1rem 2rem;
  border: none;
  border-radius: 15px;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.3s ease;
  display: inline-flex;
  align-items: center;
  gap: 0.75rem;
  text-decoration: none;
  font-size: 1.1rem;
}

.btn-primary {
  background: linear-gradient(135deg, #2d5a27, #4a7c3e);
  color: white;
  box-shadow: 0 10px 30px rgba(45, 90, 39, 0.3);
}

.btn-primary:hover {
  background: linear-gradient(135deg, #1f3f1c, #3d7a33);
  transform: translateY(-3px);
  box-shadow: 0 15px 40px rgba(45, 90, 39, 0.5);
}

.btn-secondary {
  background: #6c757d;
  color: white;
  box-shadow: 0 10px 30px rgba(108, 117, 125, 0.3);
}

.btn-secondary:hover {
  background: #5a6268;
  transform: translateY(-3px);
  box-shadow: 0 15px 40px rgba(108, 117, 125, 0.5);
}

.btn-apply {
  background: var(--light-green);
  color: white;
}

.btn-apply:hover {
  background: #6fa055;
}

.btn-lg {
  padding: 1.25rem 2.5rem;
  font-size: 1.3rem;
}

.step-actions {
  display: flex;
  gap: 1rem;
  margin-top: 2rem;
  justify-content: space-between;
}

/* Form Styles */
.form-group {
  margin-bottom: 1rem;
}

.form-group label {
  display: block;
  margin-bottom: 0.5rem;
  font-weight: 500;
  color: #333;
}

.form-group input,
.form-group select {
  width: 100%;
  padding: 0.75rem;
  border: 2px solid #ddd;
  border-radius: 8px;
  font-size: 1rem;
  transition: border-color 0.3s;
}

.form-group input:focus,
.form-group select:focus {
  outline: none;
  border-color: var(--primary-green);
}

.form-row {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 1rem;
}

/* Shipping Options */
.shipping-options {
  margin-top: 2rem;
}

.shipping-options h3 {
  color: var(--primary-green);
  margin-bottom: 1rem;
}

.shipping-option {
  display: flex;
  align-items: center;
  padding: 1rem;
  border: 2px solid #ddd;
  border-radius: 8px;
  margin-bottom: 0.75rem;
  cursor: pointer;
  transition: all 0.3s;
}

.shipping-option:hover {
  border-color: var(--light-green);
  background: #f8f9fa;
}

.shipping-option input[type="radio"] {
  margin-right: 1rem;
}

.shipping-option label {
  flex: 1;
  display: flex;
  justify-content: space-between;
  cursor: pointer;
}

/* Payment Methods */
.payment-methods {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 1rem;
  margin-bottom: 2rem;
}

.payment-method {
  padding: 1.5rem;
  border: 2px solid #ddd;
  border-radius: 8px;
  text-align: center;
  cursor: pointer;
  transition: all 0.3s;
}

.payment-method:hover {
  border-color: var(--light-green);
  background: #f8f9fa;
}

.payment-method.active {
  border-color: var(--primary-green);
  background: var(--pale-green);
}

.payment-method i {
  font-size: 2rem;
  margin-bottom: 0.5rem;
  color: var(--primary-green);
}

.payment-form {
  display: none;
}

.payment-form.card-payment {
  display: block;
}

/* Sidebar */
.checkout-sidebar {
  position: sticky;
  top: 2rem;
}

.order-summary {
  background: linear-gradient(135deg, #2d5a27 0%, #3d7a33 100%);
  padding: 3rem;
  border-radius: 25px;
  box-shadow: 0 20px 60px rgba(45, 90, 39, 0.3);
  color: white;
}

.order-summary h3 {
  color: white;
  margin-bottom: 2rem;
  display: flex;
  align-items: center;
  gap: 1rem;
  font-size: 2rem;
  font-weight: 700;
  text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
}

.summary-totals {
  margin-top: 2rem;
  padding-top: 2rem;
  border-top: 2px solid rgba(255,255,255,0.3);
}

.total-row {
  display: flex;
  justify-content: space-between;
  margin-bottom: 1rem;
  font-size: 1.1rem;
  color: rgba(255,255,255,0.9);
}

.total-row.final-total {
  margin-top: 1.5rem;
  padding-top: 1.5rem;
  border-top: 3px solid rgba(255,255,255,0.5);
  font-size: 1.5rem;
  font-weight: 800;
  color: white;
  text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
}

/* Success Modal */
.success-modal {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.7);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 10000;
}

.success-modal .modal-content {
  background: white;
  padding: 3rem;
  border-radius: 16px;
  text-align: center;
  max-width: 500px;
  animation: slideUp 0.3s;
}

@keyframes slideUp {
  from { opacity: 0; transform: translateY(50px); }
  to { opacity: 1; transform: translateY(0); }
}

.success-icon {
  font-size: 4rem;
  color: #28a745;
  margin-bottom: 1rem;
}

.success-modal h2 {
  color: var(--primary-green);
  margin-bottom: 1rem;
}

.order-details {
  margin: 2rem 0;
  padding: 1.5rem;
  background: #f8f9fa;
  border-radius: 8px;
}

.success-actions {
  margin-top: 2rem;
}

/* Responsive */
@media (max-width: 768px) {
  .checkout-content {
    grid-template-columns: 1fr;
  }
  
  .checkout-steps {
    flex-direction: column;
    gap: 1rem;
  }
  
  .checkout-steps::before {
    display: none;
  }
  
  .payment-methods {
    grid-template-columns: 1fr;
  }
}
</style>


<div class="checkout-page">
  <div class="container">
    <div class="checkout-header">
      <h1><i class="fas fa-shopping-bag"></i> Secure Checkout</h1>
      <div class="checkout-steps">
        <div class="step active" data-step="1">
          <span class="step-number">1</span>
          <span class="step-title">Order Summary</span>
        </div>
        <div class="step" data-step="2">
          <span class="step-number">2</span>
          <span class="step-title">Shipping Info</span>
        </div>
        <div class="step" data-step="3">
          <span class="step-number">3</span>
          <span class="step-title">Payment</span>
        </div>
      </div>
    </div>

    <div class="checkout-content">
      <div class="checkout-main">
        <!-- Step 1 -->
        <div class="checkout-step active" id="step-1">
          <h2><i class="fas fa-list-ul"></i> Order Summary</h2>
          <div class="order-items" id="checkout-items"></div>

          <div class="step-actions">
            <a href="/products" class="btn btn-secondary"><i class="fas fa-arrow-left"></i> Continue Shopping</a>
            <button type="button" class="btn btn-primary" id="continue-to-shipping-btn" onclick="console.log('üîò onclick fired!'); nextStep();">Continue to Shipping <i class="fas fa-arrow-right"></i></button>
          </div>
        </div>

        <!-- Step 2 -->
        <div class="checkout-step" id="step-2">
          <h2><i class="fas fa-shipping-fast"></i> Shipping Information</h2>
          <form class="shipping-form">
            <div class="form-row">
              <div class="form-group">
                <label for="firstName">First Name *</label>
                <input type="text" id="firstName" required>
              </div>
              <div class="form-group">
                <label for="lastName">Last Name *</label>
                <input type="text" id="lastName" required>
              </div>
            </div>

            <div class="form-group">
              <label for="email">Email Address *</label>
              <input type="email" id="email" required>
            </div>

            <div class="form-group">
              <label for="phone">Phone Number *</label>
              <input type="tel" id="phone" required>
            </div>

            <div class="form-group">
              <label for="address">Address *</label>
              <input type="text" id="address" placeholder="Street address" required>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="city">City *</label>
                <input type="text" id="city" required>
              </div>
              <div class="form-group">
                <label for="state">State *</label>
                <select id="state" required>
                  <option value="">Select State</option>
                  <option value="AN">Andaman and Nicobar Islands</option>
                  <option value="AP">Andhra Pradesh</option>
                  <option value="AR">Arunachal Pradesh</option>
                  <option value="AS">Assam</option>
                  <option value="BR">Bihar</option>
                  <option value="CH">Chandigarh</option>
                  <option value="CG">Chhattisgarh</option>
                  <option value="DN">Dadra and Nagar Haveli and Daman and Diu</option>
                  <option value="DL">Delhi</option>
                  <option value="GA">Goa</option>
                  <option value="GJ">Gujarat</option>
                  <option value="HR">Haryana</option>
                  <option value="HP">Himachal Pradesh</option>
                  <option value="JK">Jammu and Kashmir</option>
                  <option value="JH">Jharkhand</option>
                  <option value="KA">Karnataka</option>
                  <option value="KL">Kerala</option>
                  <option value="LA">Ladakh</option>
                  <option value="LD">Lakshadweep</option>
                  <option value="MP">Madhya Pradesh</option>
                  <option value="MH">Maharashtra</option>
                  <option value="MN">Manipur</option>
                  <option value="ML">Meghalaya</option>
                  <option value="MZ">Mizoram</option>
                  <option value="NL">Nagaland</option>
                  <option value="OR">Odisha</option>
                  <option value="PY">Puducherry</option>
                  <option value="PB">Punjab</option>
                  <option value="RJ">Rajasthan</option>
                  <option value="SK">Sikkim</option>
                  <option value="TN">Tamil Nadu</option>
                  <option value="TS">Telangana</option>
                  <option value="TR">Tripura</option>
                  <option value="UP">Uttar Pradesh</option>
                  <option value="UK">Uttarakhand</option>
                  <option value="WB">West Bengal</option>
                </select>
              </div>
              <div class="form-group">
                <label for="zipCode">PIN Code *</label>
                <input type="text" id="zipCode" placeholder="e.g. 110001" required>
              </div>
            </div>

            <div class="shipping-options">
              <h3>Shipping Method</h3>
              <div class="shipping-option">
                <input type="radio" id="standard" name="shipping" value="standard" checked>
                <label for="standard">
                  <span class="option-name">Standard (5‚Äì7 days)</span>
                  <span class="option-price">‚Çπ99</span>
                </label>
              </div>
              <div class="shipping-option">
                <input type="radio" id="express" name="shipping" value="express">
                <label for="express">
                  <span class="option-name">Express (2‚Äì3 days)</span>
                  <span class="option-price">‚Çπ199</span>
                </label>
              </div>
            </div>
          </form>

          <div class="step-actions">
            <button type="button" class="btn btn-secondary" id="back-to-order-btn" onclick="prevStep()"><i class="fas fa-arrow-left"></i> Back to Order</button>
            <button type="button" class="btn btn-primary" id="continue-to-payment-btn" onclick="nextStep()">Continue to Payment <i class="fas fa-arrow-right"></i></button>
          </div>
        </div>

        <!-- Step 3 -->
        <div class="checkout-step" id="step-3">
          <h2><i class="fas fa-credit-card"></i> Payment Information</h2>
          <div class="payment-methods">
            <div class="payment-method active" data-method="card">
              <i class="fas fa-credit-card"></i>
              <span>Credit/Debit Card</span>
            </div>
            <div class="payment-method" data-method="paypal">
              <i class="fab fa-paypal"></i>
              <span>PayPal</span>
            </div>
          </div>

          <div class="payment-form card-payment">
            <div class="form-group">
              <label for="cardNumber">Card Number *</label>
              <input type="text" id="cardNumber" placeholder="1234 5678 9012 3456" required>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="expiryDate">Expiry *</label>
                <input type="text" id="expiryDate" placeholder="MM/YY" required>
              </div>
              <div class="form-group">
                <label for="cvv">CVV *</label>
                <input type="text" id="cvv" placeholder="123" required>
              </div>
            </div>
            <div class="form-group">
              <label for="cardName">Name on Card *</label>
              <input type="text" id="cardName" required>
            </div>
          </div>

          <div class="step-actions">
            <button type="button" class="btn btn-secondary" id="back-btn" onclick="prevStep()"><i class="fas fa-arrow-left"></i> Back</button>
            <button type="button" class="btn btn-primary btn-lg" id="complete-order-btn" onclick="processPayment()">
              <i class="fas fa-lock"></i> Complete Order Securely
            </button>
          </div>
        </div>
      </div>

      <div class="checkout-sidebar">
        <div class="order-summary">
          <h3><i class="fas fa-receipt"></i> Order Summary</h3>
          <div class="summary-items" id="summary-items"></div>
          <div class="summary-totals">
            <div class="total-row"><span>Subtotal:</span><span id="subtotal-amount">‚Çπ0</span></div>
            <div class="total-row"><span>Shipping:</span><span id="shipping-amount">‚Çπ99</span></div>
            <div class="total-row"><span>Tax:</span><span id="tax-amount">‚Çπ0</span></div>
            <div class="total-row final-total"><span>Total:</span><span id="final-total">‚Çπ0</span></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Success Modal -->
<div class="modal success-modal" id="success-modal">
  <div class="modal-content">
    <div class="success-icon"><i class="fas fa-check-circle"></i></div>
    <h2>Order Confirmed!</h2>
    <p>Thank you for your purchase. Your order will be shipped soon.</p>
    <div class="order-details">
      <p><strong>Order #:</strong> <span id="order-number"></span></p>
      <p><strong>Est. Delivery:</strong> <span id="delivery-date"></span></p>
    </div>
    <div class="success-actions">
      <a href="/products" class="btn btn-secondary">Continue Shopping</a>
    </div>
  </div>
</div>

<!-- Loading Overlay -->
<div id="loading-overlay">
  <div class="spinner"></div>
  <p>Processing Payment...</p>
</div>

<style>
#loading-overlay {
  position: fixed;
  inset: 0;
  background: rgba(255,255,255,0.85);
  backdrop-filter: blur(3px);
  display: none;
  align-items: center;
  justify-content: center;
  flex-direction: column;
  z-index: 100000;
}
#loading-overlay .spinner {
  width: 60px; height: 60px;
  border: 5px solid #ccc;
  border-top-color: var(--primary-green);
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin-bottom: 1rem;
}
@keyframes spin {to {transform: rotate(360deg)}}
</style>

<script>
// ============================================================
// CHECKOUT PAGE - COMPLETE WORKING VERSION
// ============================================================

let currentStep = 1;
let cartData = null;
let shippingCost = 99;
let taxRate = 0.08;

// ============================================================
// INITIALIZATION
// ============================================================

function initializeCheckout() {
  console.log('üöÄ Initializing checkout...');
  
  // Make sure only step 1 is visible
  document.getElementById('step-1').style.display = 'block';
  document.getElementById('step-2').style.display = 'none';
  document.getElementById('step-3').style.display = 'none';
  
  // Load cart data first, then update display
  loadCartData();
  setupEventListeners();
  
  console.log('‚úÖ Checkout ready - Step 1 visible');
}

function loadCartData() {
  try {
    const savedCart = localStorage.getItem('plant-nursery-cart');
    console.log('üì¶ Raw cart data from localStorage:', savedCart);
    
    if (savedCart) {
      const items = JSON.parse(savedCart);
      console.log('üì¶ Parsed cart items:', items);
      
      if (!Array.isArray(items) || items.length === 0) {
        console.log('‚ö†Ô∏è Cart is empty or invalid');
        cartData = { items: [], isEmpty: true, totalItems: 0, totalAmount: 0 };
        showEmptyCartMessage();
        return;
      }
      
      cartData = {
        items: items,
        isEmpty: false,
        totalItems: items.reduce((sum, item) => sum + (item.quantity || 1), 0),
        totalAmount: items.reduce((sum, item) => sum + ((item.price || 0) * (item.quantity || 1)), 0)
      };
      console.log('‚úÖ Cart loaded successfully:', cartData);
      
      // Update display after loading
      updateOrderSummary();
    } else {
      console.log('‚ö†Ô∏è No cart data found in localStorage');
      cartData = { items: [], isEmpty: true, totalItems: 0, totalAmount: 0 };
      showEmptyCartMessage();
    }
  } catch (error) {
    console.error('‚ùå Error loading cart:', error);
    cartData = { items: [], isEmpty: true, totalItems: 0, totalAmount: 0 };
    showEmptyCartMessage();
  }
}

function showEmptyCartMessage() {
  const checkoutItems = document.getElementById('checkout-items');
  if (checkoutItems) {
    checkoutItems.innerHTML = `
      <div style="text-align:center;padding:3rem;background:#f8f9fa;border-radius:8px;">
        <i class="fas fa-shopping-cart" style="font-size:3rem;color:#ccc;margin-bottom:1rem;"></i>
        <h3 style="color:#666;margin-bottom:0.5rem;">Your cart is empty</h3>
        <p style="color:#999;margin-bottom:1.5rem;">Add some items to your cart to proceed with checkout.</p>
        <a href="/products" class="btn btn-primary">
          <i class="fas fa-arrow-left"></i> Continue Shopping
        </a>
      </div>
    `;
  }
  
  // Update summary to show zeros
  const summaryItems = document.getElementById('summary-items');
  if (summaryItems) {
    summaryItems.innerHTML = '<p style="color:#999;text-align:center;">No items in cart</p>';
  }
  
  document.getElementById('subtotal-amount').textContent = '‚Çπ0';
  document.getElementById('tax-amount').textContent = '‚Çπ0';
  document.getElementById('final-total').textContent = '‚Çπ0';
}

function updateOrderSummary() {
  if (!cartData || cartData.isEmpty || !cartData.items || cartData.items.length === 0) {
    console.log('‚ö†Ô∏è Cannot update order summary - cart is empty');
    showEmptyCartMessage();
    return;
  }
  
  console.log('üìä Updating order summary with', cartData.items.length, 'items');
  
  // Update cart items display
  const checkoutItems = document.getElementById('checkout-items');
  if (checkoutItems) {
    checkoutItems.innerHTML = cartData.items.map(item => {
      const imageUrl = item.image || '/images/DemoPotPlant.jpg';
      const itemName = item.name || 'Unknown Product';
      const itemPrice = parseFloat(item.price) || 0;
      const itemQuantity = parseInt(item.quantity) || 1;
      const itemTotal = itemPrice * itemQuantity;
      
      return `
        <div class="checkout-item" style="display:flex;gap:1rem;margin-bottom:1rem;padding:1rem;background:#f8f9fa;border-radius:8px;border:1px solid #e0e0e0;">
          <img src="${imageUrl}" alt="${itemName}" style="width:80px;height:80px;object-fit:cover;border-radius:4px;background:#fff;">
          <div style="flex:1;">
            <h4 style="margin:0 0 0.5rem 0;color:var(--primary-green);">${itemName}</h4>
            <p style="margin:0 0 0.5rem 0;color:#666;font-size:0.9rem;">Quantity: ${itemQuantity}</p>
            <p style="margin:0.5rem 0 0 0;font-weight:600;color:var(--primary-green);font-size:1.1rem;">‚Çπ${itemTotal.toFixed(2)}</p>
          </div>
        </div>
      `;
    }).join('');
  }
  
  // Update summary sidebar
  const summaryItems = document.getElementById('summary-items');
  if (summaryItems) {
    summaryItems.innerHTML = cartData.items.map(item => {
      const itemName = item.name || 'Unknown Product';
      const itemPrice = parseFloat(item.price) || 0;
      const itemQuantity = parseInt(item.quantity) || 1;
      const itemTotal = itemPrice * itemQuantity;
      
      return `
        <div style="display:flex;justify-content:space-between;margin-bottom:0.75rem;padding-bottom:0.75rem;border-bottom:1px solid #eee;">
          <span style="color:#333;">${itemName} x${itemQuantity}</span>
          <span style="font-weight:600;color:var(--primary-green);">‚Çπ${itemTotal.toFixed(2)}</span>
        </div>
      `;
    }).join('');
  }
  
  // Calculate and update totals
  const subtotal = cartData.totalAmount || 0;
  const tax = subtotal * taxRate;
  const total = subtotal + shippingCost + tax;
  
  const subtotalEl = document.getElementById('subtotal-amount');
  const taxEl = document.getElementById('tax-amount');
  const totalEl = document.getElementById('final-total');
  
  if (subtotalEl) subtotalEl.textContent = `‚Çπ${subtotal.toFixed(2)}`;
  if (taxEl) taxEl.textContent = `‚Çπ${tax.toFixed(2)}`;
  if (totalEl) totalEl.textContent = `‚Çπ${total.toFixed(2)}`;
  
  console.log('‚úÖ Order summary updated - Subtotal:', subtotal, 'Total:', total);
}

function setupEventListeners() {
  // Payment method selection
  document.querySelectorAll('.payment-method').forEach(method => {
    method.addEventListener('click', function() {
      document.querySelectorAll('.payment-method').forEach(m => m.classList.remove('active'));
      this.classList.add('active');
      
      const selectedMethod = this.getAttribute('data-method');
      document.querySelectorAll('.payment-form').forEach(form => {
        if (form.classList.contains(`${selectedMethod}-payment`)) {
          form.style.display = 'block';
        } else {
          form.style.display = 'none';
        }
      });
    });
  });
  
  // Shipping method change
  document.querySelectorAll('input[name="shipping"]').forEach(radio => {
    radio.addEventListener('change', function() {
      const prices = { standard: 99, express: 199 };
      shippingCost = prices[this.value] || 99;
      document.getElementById('shipping-amount').textContent = `‚Çπ${shippingCost.toFixed(2)}`;
      updateOrderSummary();
    });
  });
}

// ============================================================
// GLOBAL FUNCTIONS (accessible from onclick)
// ============================================================

window.nextStep = function() {
  console.log('‚ñ∂Ô∏è‚ñ∂Ô∏è‚ñ∂Ô∏è NEXTSTEP FUNCTION CALLED! ‚ñ∂Ô∏è‚ñ∂Ô∏è‚ñ∂Ô∏è');
  console.log('Current step:', currentStep);
  console.log('Step 1 element:', document.getElementById('step-1'));
  console.log('Step 2 element:', document.getElementById('step-2'));
  
  // For step 1, just move to step 2 (no validation)
  if (currentStep === 1) {
    console.log('‚úÖ We are on step 1, moving to step 2...');
    
    // Hide step 1
    const step1 = document.getElementById('step-1');
    if (step1) {
      step1.style.display = 'none';
      console.log('‚úÖ Step 1 hidden');
    } else {
      console.error('‚ùå Step 1 element not found!');
    }
    
    document.querySelectorAll('.step')[0].classList.remove('active');
    
    // Show step 2
    const step2 = document.getElementById('step-2');
    if (step2) {
      step2.style.display = 'block';
      console.log('‚úÖ Step 2 shown');
    } else {
      console.error('‚ùå Step 2 element not found!');
    }
    
    document.querySelectorAll('.step')[1].classList.add('active');
    
    currentStep = 2;
    console.log('‚úÖ Now on step 2');
    window.scrollTo(0, 0);
    return;
  }
  
  // For step 2, validate then move to step 3
  if (currentStep === 2) {
    const shippingFields = ['firstName', 'lastName', 'email', 'phone', 'address', 'city', 'state', 'zipCode'];
    let valid = true;
    
    shippingFields.forEach(id => {
      const el = document.getElementById(id);
      if (!el || !el.value.trim()) {
        if (el) el.style.borderColor = 'red';
        valid = false;
      } else {
        if (el) el.style.borderColor = '';
      }
    });
    
    if (!valid) {
      alert('‚ö†Ô∏è Please fill all shipping fields');
      return;
    }
    
    // Hide step 2
    document.getElementById('step-2').style.display = 'none';
    document.querySelectorAll('.step')[1].classList.remove('active');
    
    // Show step 3
    document.getElementById('step-3').style.display = 'block';
    document.querySelectorAll('.step')[2].classList.add('active');
    
    currentStep = 3;
    console.log('‚úÖ Now on step 3');
    window.scrollTo(0, 0);
  }
}

window.prevStep = function() {
  console.log('‚óÄÔ∏è BACK BUTTON - Moving from step', currentStep);
  
  if (currentStep === 2) {
    // Hide step 2
    document.getElementById('step-2').style.display = 'none';
    document.querySelectorAll('.step')[1].classList.remove('active');
    
    // Show step 1
    document.getElementById('step-1').style.display = 'block';
    document.querySelectorAll('.step')[0].classList.add('active');
    
    currentStep = 1;
    console.log('‚úÖ Back to step 1');
    window.scrollTo(0, 0);
  } else if (currentStep === 3) {
    // Hide step 3
    document.getElementById('step-3').style.display = 'none';
    document.querySelectorAll('.step')[2].classList.remove('active');
    
    // Show step 2
    document.getElementById('step-2').style.display = 'block';
    document.querySelectorAll('.step')[1].classList.add('active');
    
    currentStep = 2;
    console.log('‚úÖ Back to step 2');
    window.scrollTo(0, 0);
  }
}

window.processPayment = function() {
  console.log('üí≥ Process payment clicked');
  
  if (!validateCurrentStep()) {
    console.log('‚ùå Payment validation failed');
    return;
  }
  
  // Show loading overlay
  const overlay = document.getElementById('loading-overlay');
  if (overlay) overlay.style.display = 'flex';
  
  // Get form data
  const firstName = document.getElementById('firstName').value;
  const lastName = document.getElementById('lastName').value;
  const email = document.getElementById('email').value;
  const phone = document.getElementById('phone').value;
  const address = document.getElementById('address').value;
  const city = document.getElementById('city').value;
  const state = document.getElementById('state').value;
  const zipCode = document.getElementById('zipCode').value;
  
  // Calculate final total
  const total = parseFloat(document.getElementById('final-total').textContent.replace('‚Çπ', '').replace(',', ''));
  
  // Get payment method
  const paymentMethod = document.querySelector('.payment-method.active')?.getAttribute('data-method') || 'card';
  
  // Prepare shipping info
  const shippingInfo = {
    firstName,
    lastName,
    email,
    phone,
    address,
    city,
    state,
    zipCode
  };
  
  console.log('üí∞ Processing payment:', {
    name: `${firstName} ${lastName}`,
    email: email,
    amount: total,
    method: paymentMethod,
    cart: cartData.items,
    shippingInfo
  });
  
  // Send payment request
  fetch('/api/payment/checkout', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      name: `${firstName} ${lastName}`,
      email: email,
      amount: total,
      method: paymentMethod,
      cart: cartData.items,
      shippingInfo: shippingInfo
    })
  })
  .then(response => response.json())
  .then(data => {
    if (overlay) overlay.style.display = 'none';
    
    if (data.success) {
      console.log('‚úÖ Payment successful!', data);
      
      // Update success modal
      document.getElementById('order-number').textContent = data.transactionId;
      
      const deliveryDate = new Date();
      deliveryDate.setDate(deliveryDate.getDate() + 7);
      document.getElementById('delivery-date').textContent = deliveryDate.toLocaleDateString('en-US', { 
        weekday: 'short', 
        year: 'numeric', 
        month: 'short', 
        day: 'numeric' 
      });
      
      // Show success modal
      document.getElementById('success-modal').style.display = 'flex';
      
      // Clear cart
      localStorage.removeItem('plant-nursery-cart');
      
      // Update cart count if function exists
      if (typeof updateCartCount === 'function') {
        updateCartCount();
      }
      
      // Redirect to home page after 3 seconds
      setTimeout(() => {
        window.location.href = '/';
      }, 3000);
    } else {
      throw new Error(data.error || 'Payment failed');
    }
  })
  .catch(error => {
    console.error('‚ùå Payment error:', error);
    if (overlay) overlay.style.display = 'none';
    alert('‚ùå Payment failed: ' + error.message + '\n\nPlease try again.');
  });
}

// ============================================================
// VALIDATION FUNCTIONS
// ============================================================

function validateCurrentStep() {
  switch (currentStep) {
    case 1:
      // Order summary - no validation needed
      return true;
      
    case 2:
      // Shipping information validation
      const shippingFields = ['firstName', 'lastName', 'email', 'phone', 'address', 'city', 'state', 'zipCode'];
      let allFilled = true;
      
      shippingFields.forEach(fieldId => {
        const element = document.getElementById(fieldId);
        if (!element || !element.value.trim()) {
          if (element) element.style.borderColor = 'red';
          allFilled = false;
        } else {
          if (element) element.style.borderColor = '';
        }
      });
      
      if (!allFilled) {
        alert('‚ö†Ô∏è Please fill in all required shipping fields.');
        return false;
      }
      
      // Validate email format
      const email = document.getElementById('email').value;
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(email)) {
        alert('‚ö†Ô∏è Please enter a valid email address.');
        document.getElementById('email').style.borderColor = 'red';
        return false;
      }
      
      return true;
      
    case 3:
      // Payment validation
      const activeMethod = document.querySelector('.payment-method.active')?.getAttribute('data-method');
      
      if (activeMethod === 'card') {
        const paymentFields = ['cardNumber', 'expiryDate', 'cvv', 'cardName'];
        let allFilled = true;
        
        paymentFields.forEach(fieldId => {
          const element = document.getElementById(fieldId);
          if (!element || !element.value.trim()) {
            if (element) element.style.borderColor = 'red';
            allFilled = false;
          } else {
            if (element) element.style.borderColor = '';
          }
        });
        
        if (!allFilled) {
          alert('‚ö†Ô∏è Please fill in all payment card fields.');
          return false;
        }
      }
      
      return true;
      
    default:
      return true;
  }
}

// ============================================================
// INITIALIZE ON PAGE LOAD
// ============================================================

document.addEventListener('DOMContentLoaded', function() {
  console.log('üå± DOM loaded, initializing checkout...');
  initializeCheckout();
  
  // Test global functions
  console.log('üß™ Global functions check:');
  console.log('  nextStep:', typeof window.nextStep);
  console.log('  prevStep:', typeof window.prevStep);
  console.log('  processPayment:', typeof window.processPayment);
  
  // Fix all buttons with icons that prevent onclick from firing
  const buttonConfigs = [
    { id: 'continue-to-shipping-btn', action: () => window.nextStep(), name: 'Continue to Shipping' },
    { id: 'continue-to-payment-btn', action: () => window.nextStep(), name: 'Continue to Payment' },
    { id: 'back-to-order-btn', action: () => window.prevStep(), name: 'Back to Order' },
    { id: 'back-btn', action: () => window.prevStep(), name: 'Back' },
    { id: 'complete-order-btn', action: () => window.processPayment(), name: 'Complete Order' }
  ];
  
  buttonConfigs.forEach(config => {
    const btn = document.getElementById(config.id);
    if (btn) {
      console.log(`‚úÖ Found ${config.name} button`);
      btn.addEventListener('click', function(e) {
        console.log(`üîò ${config.name} clicked!`);
        e.preventDefault();
        e.stopPropagation();
        config.action();
      });
    } else {
      console.warn(`‚ö†Ô∏è ${config.name} button not found (ID: ${config.id})`);
    }
  });
  
  // Make nextStep available in console for testing
  window.testNextStep = function() {
    console.log('üß™ Manual test of nextStep...');
    window.nextStep();
  };
  
  console.log('üí° TIP: Type "testNextStep()" in console to test the function manually');
});
</script>
